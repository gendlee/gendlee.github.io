<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🦜&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>0019 Redis缓存的更新策略&nbsp;|&nbsp;锡安的自留地</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="0019 Redis缓存的更新策略">
  
    <meta name="description" content="Redis缓存的更新策略">
    <meta property="og:description" content="Redis缓存的更新策略">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🏝️&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🦜&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="e48d9ceebf4c4de2b657c3a3d1d308f4.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🧰&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>工具</span>
        </div>
      </a>
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🎏&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>关于我</span>
        </div>
      </a>
    
  
</nav>
  <header class="Header">
    
      <div class="Header__Cover">
        <img src="https://www.notion.so/images/page-cover/met_william_morris_1877_willow.jpg">
      </div>
    
    <div class="Header__Spacer ">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🏝️&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">0019 Redis缓存的更新策略</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Sat, Oct 5, 2024</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--purple">
            <a href="tag/DB.html">DB</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--red">
            <a href="tag/解决方案.html">解决方案</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/113a920890b18053aad7c27c8effee4f" class="PageRoot"><div id="https://www.notion.so/116a920890b180de83bec9d48830e6cf" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在很多高并发的场景如秒杀系统，QPS会瞬时暴增，如果采用直接读写数据库（如MySQL）的方式，很可能会将数据库打垮。因此这种场景需要引入Redis做缓存，应对高并发的访问。但同时也会引入新的风险，最常见的就是缓存与数据库的一致性问题。下面我们来看一下一些常见的方案。</span></span></p></div><h1 id="https://www.notion.so/116a920890b18053a587ccc756feac93" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/116a920890b18053a587ccc756feac93"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">1.Cache Aside（懒加载）模式</span></span></h1><div id="https://www.notion.so/116a920890b18074ab29e7838cb720da" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2F26aa1b0e-b3b9-46e2-b660-0a2084914d44%2FCache_Aside.png?width=1232.5125732421875&amp;table=block&amp;id=116a9208-90b1-8074-ab29-e7838cb720da"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2F26aa1b0e-b3b9-46e2-b660-0a2084914d44%2FCache_Aside.png?width=1232.5125732421875&amp;table=block&amp;id=116a9208-90b1-8074-ab29-e7838cb720da" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/116a920890b1809da3c1e6b05c19827d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">这是最常用的缓存模式之一。在这个模式下，数据更新的主流程发生在数据库中，缓存会根据需要来更新或失效。</span></span></p></div><div id="https://www.notion.so/116a920890b180f584f4fdea73c44a45" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">流程</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b180a29301ebbef14d8dfc" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">查询</strong></span><span class="SemanticString">时，应用首先查询缓存，如果缓存中有数据（缓存命中），则直接返回缓存数据；如果缓存没有数据（缓存未命中），则查询数据库，得到数据后返回并更新缓存。</span></span></li><li id="https://www.notion.so/116a920890b1803b8fd4f91be4306a64" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">更新</strong></span><span class="SemanticString">时，应用首先更新数据库，然后将对应的缓存删除或更新（</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">通常删除缓存</strong></span><span class="SemanticString">让下一次查询时重新加载）。</span></span></li></ul><div id="https://www.notion.so/116a920890b18076a9b6cd60d642b130" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">优点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b18060a159c76ebb37ecb0" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">数据一致性较好，因为写操作直接作用在数据库，缓存仅在需要时更新。</span></span></li><li id="https://www.notion.so/116a920890b18003a1d1d2055291d7b5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">缓存可以有效减少数据库的压力。</span></span></li></ul><div id="https://www.notion.so/116a920890b1804abee4f6050beffa81" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">缺点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b18092bfbaf181741962ed" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">第一次查询时，如果缓存中没有数据，会引发数据库查询，可能导致缓存未命中的延迟问题。</span></span></li><li id="https://www.notion.so/116a920890b18012aedac98b8690ac46" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">如果删除缓存失败，可能会导致缓存与数据库数据不一致。</span></span></li></ul><div id="https://www.notion.so/116a920890b1804187edd33806ef1b30" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2F69d009ef-ed9c-4af9-98d4-708e1cac8074%2F0019-Cache_Aside-%25E4%25B8%258D%25E4%25B8%2580%25E8%2587%25B4.drawio.png?width=1232.5125732421875&amp;table=block&amp;id=116a9208-90b1-8041-87ed-d33806ef1b30"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2F69d009ef-ed9c-4af9-98d4-708e1cac8074%2F0019-Cache_Aside-%25E4%25B8%258D%25E4%25B8%2580%25E8%2587%25B4.drawio.png?width=1232.5125732421875&amp;table=block&amp;id=116a9208-90b1-8041-87ed-d33806ef1b30" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/116a920890b180a7b1b6e83d1b2459d9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h1 id="https://www.notion.so/116a920890b1804aaf23ebd8092ea592" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/116a920890b1804aaf23ebd8092ea592"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2.同步更新模式（Write Through）</span></span></h1><div id="https://www.notion.so/116a920890b180b7b584f77010b72cdd" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2Fcce3b451-9835-416e-b1a5-6032e904d5e7%2F0019-Write_Through.drawio.png?width=707.9750366210938&amp;table=block&amp;id=116a9208-90b1-80b7-b584-f77010b72cdd"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2Fcce3b451-9835-416e-b1a5-6032e904d5e7%2F0019-Write_Through.drawio.png?width=707.9750366210938&amp;table=block&amp;id=116a9208-90b1-80b7-b584-f77010b72cdd" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/116a920890b180ce87fcf7117c7f9218" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在这个策略下，每次对数据库进行写操作时，缓存会同步更新，也就是写缓存和同步数据库是原子操作，其中一步失败均认为写入失败。</span></span></p></div><div id="https://www.notion.so/116a920890b180109260f543b5963d5b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">流程</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b18006a339c52f92396d85" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">写入</strong></span><span class="SemanticString">时，应用首先将数据写入缓存，然后通过缓存同步到数据库。</span></span></li><li id="https://www.notion.so/116a920890b180c184fbc038e015e4ec" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">查询</strong></span><span class="SemanticString">时，直接从缓存中读取数据。</span></span></li></ul><div id="https://www.notion.so/116a920890b180078ee3dd7a8d2e243c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">优点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b1804aa0cfc9370d839ef0" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">查询时性能更高，因为数据总是直接从缓存中获取。</span></span></li><li id="https://www.notion.so/116a920890b18081a4a7c5f504c515c1" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">数据一致性较好，因为每次写操作都会同时更新缓存和数据库。</span></span></li></ul><div id="https://www.notion.so/116a920890b1809ebad3c6f17f71345a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">缺点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b1806f8f17d4eb6bf0d95d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">每次写操作都要更新缓存和数据库，写入性能可能较低。</span></span></li><li id="https://www.notion.so/116a920890b1806e810ee4497b7cee38" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">如果数据库写入失败（但是写入者没有感知到，或原子性策略不成功），缓存和数据库可能出现不一致的情况。</span></span></li></ul><h1 id="https://www.notion.so/116a920890b180368a2bdf591e6c09ee" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/116a920890b180368a2bdf591e6c09ee"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">3.异步更新模式（Write Behind）</span></span></h1><div id="https://www.notion.so/116a920890b1800a92f9d78ad2547518" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2F350ab10f-f0ca-4bde-b3a0-aa2d52dafe55%2F0019-Write_Behind.drawio.png?width=707.9750366210938&amp;table=block&amp;id=116a9208-90b1-800a-92f9-d78ad2547518"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2F350ab10f-f0ca-4bde-b3a0-aa2d52dafe55%2F0019-Write_Behind.drawio.png?width=707.9750366210938&amp;table=block&amp;id=116a9208-90b1-800a-92f9-d78ad2547518" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/116a920890b1805e8c10dcd7d83b2411" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">这个模式下，写操作只作用于缓存，缓存中的数据异步写入到数据库中。</span></span></p></div><div id="https://www.notion.so/116a920890b1800089c6e6f4f8ff74b8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">流程</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b180a6ad08e634f0ec80ce" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">写入</strong></span><span class="SemanticString">时，应用先将数据写入缓存，然后异步地将数据写入数据库。</span></span></li><li id="https://www.notion.so/116a920890b180c2818cf326d1b2395e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">查询</strong></span><span class="SemanticString">时，直接从缓存中读取数据。</span></span></li></ul><div id="https://www.notion.so/116a920890b18036b31deffeac756dee" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">优点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b180a18912e77cb3c0ba8b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">写操作性能较高，因为不需要立即更新数据库。</span></span></li><li id="https://www.notion.so/116a920890b1804ea9a7cc742681116a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">查询效率也高，因为数据总是从缓存中获取。</span></span></li></ul><div id="https://www.notion.so/116a920890b180e880bbd45afcf26318" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">缺点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b18045b886dcb687b6f10f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">存在数据一致性风险，因为数据可能还未同步到数据库就被读取。</span></span></li><li id="https://www.notion.so/116a920890b180cb965decc24292d696" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">如果系统崩溃，可能会导致数据丢失。</span></span></li></ul><div id="https://www.notion.so/116a920890b180cdbfdffb6d8dd49f8f" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2F382e6c3b-aabb-477d-80dd-6d920f19bdb7%2F0019-Write_Behind-%25E4%25B8%258D%25E4%25B8%2580%25E8%2587%25B4.drawio.png?width=707.9874877929688&amp;table=block&amp;id=116a9208-90b1-80cd-bfdf-fb6d8dd49f8f"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2F382e6c3b-aabb-477d-80dd-6d920f19bdb7%2F0019-Write_Behind-%25E4%25B8%258D%25E4%25B8%2580%25E8%2587%25B4.drawio.png?width=707.9874877929688&amp;table=block&amp;id=116a9208-90b1-80cd-bfdf-fb6d8dd49f8f" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/116a920890b1807999a5c59067bac070" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">同步更新和 异步更新模式的关键区别：</span></span></p></div><h3 id="https://www.notion.so/116a920890b18084847cf7611ab3c0a5" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/116a920890b18084847cf7611ab3c0a5"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">同步更新模式</span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b18074a803c40feb9c917e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">强一致性</strong></span><span class="SemanticString">：只有当缓存和数据库都成功写入时，才认为写入操作成功。</span></span></li><li id="https://www.notion.so/116a920890b1803dbcfdf7110f8596a3" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">失败处理</strong></span><span class="SemanticString">：如果任一写入失败，整个操作会被视为失败，通常需要进行错误处理或重试。</span></span></li><li id="https://www.notion.so/116a920890b180679be8c930e1b49293" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">保证数据一致性</strong></span><span class="SemanticString">：确保数据在缓存和数据库中始终保持一致性。</span></span></li></ul><h3 id="https://www.notion.so/116a920890b180b4a31ee8c0f4cbdbd2" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/116a920890b180b4a31ee8c0f4cbdbd2"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">异步更新模式</span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b1802085c1c4329d4a4d15" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">弱一致性</strong></span><span class="SemanticString">：只要缓存写入成功，操作就被视为成功，即使数据库写入失败。</span></span></li><li id="https://www.notion.so/116a920890b180a19962cf88470ccc40" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">异步处理</strong></span><span class="SemanticString">：数据库的写入在后台进行，可能导致短时间内的数据不一致。</span></span></li><li id="https://www.notion.so/116a920890b1803199f8c8e6a2d29554" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">性能优先</strong></span><span class="SemanticString">：提升了写入性能，适合对实时性要求不高的场景。</span></span></li></ul><div id="https://www.notion.so/116a920890b1801eabd6c7676d9e74e2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">这种设计选择取决于具体的业务需求和对一致性的要求。</span></span></p></div><h1 id="https://www.notion.so/116a920890b18050b80cfcb0ae0d1c1f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/116a920890b18050b80cfcb0ae0d1c1f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">4.提前刷新模式（Refresh Ahead）</span></span></h1><div id="https://www.notion.so/116a920890b180f0b40cc2e088041ee3" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2F060aebc9-cf90-4c16-94a3-1e3fbffc18b4%2F0019-Refresh_Ahead.drawio.png?width=1232.5125732421875&amp;table=block&amp;id=116a9208-90b1-80f0-b40c-c2e088041ee3"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2F060aebc9-cf90-4c16-94a3-1e3fbffc18b4%2F0019-Refresh_Ahead.drawio.png?width=1232.5125732421875&amp;table=block&amp;id=116a9208-90b1-80f0-b40c-c2e088041ee3" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/116a920890b180b2b2c9c79e45e29d2a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Refresh Ahead 主要是针对读场景的优化策略，其核心目的是在数据即将过期时提前刷新缓存，以提高查询性能。在写入操作方面，通常仍然是直接写入数据库。</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b180789984f17d7021fe10" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">读场景</strong></span><span class="SemanticString">：通过预先刷新，确保缓存中的数据在高频访问时始终可用。</span></span></li><li id="https://www.notion.so/116a920890b1805ab6fac09ff5fd94f0" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">写场景</strong></span><span class="SemanticString">：依赖于数据库的更新，可能会使用其他策略（如 Write Through 或 Write Behind）来处理缓存和数据库之间的一致性。</span></span></li></ul><h3 id="https://www.notion.so/116a920890b180aa9dadf7974a990008" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/116a920890b180aa9dadf7974a990008"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">写入流程</span></span></h3><ol class="NumberedListWrapper"><li id="https://www.notion.so/116a920890b180f8a2f2eb705acfcb90" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">直接写数据库</strong></span><span class="SemanticString">：当应用需要更新数据时，首先将数据写入数据库。</span></span></li><li id="https://www.notion.so/116a920890b180b195cceb7b67ce076f" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">更新缓存（可选）</strong></span><span class="SemanticString">：可以选择立即更新缓存（如 Write Through），或在后台刷新（如 Write Behind）。</span></span></li><li id="https://www.notion.so/116a920890b180c6aa66f5881ba6e9dc" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">缓存刷新</strong></span><span class="SemanticString">：在 Refresh Ahead 策略下，缓存会在接近过期时被异步刷新，以确保数据的可用性。</span></span></li></ol><div id="https://www.notion.so/116a920890b180818368c22a0a6bcfb7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">优点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b180ffb24fdf1d724bd5fa" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">查询时减少缓存未命中的概率，避免查询时去读取数据库，提高系统性能。</span></span></li><li id="https://www.notion.so/116a920890b18040a654c5f4f920d9d1" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">对频繁访问的数据非常有效。</span></span></li></ul><div id="https://www.notion.so/116a920890b180e894a1dd58490ee27a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">缺点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b180eca93ce79b3dd7c75a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">如果频繁刷新但实际查询量不大，可能会带来不必要的开销。</span></span></li><li id="https://www.notion.so/116a920890b180aea5facff0e093204d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">可能会引发数据不一致，特别是在缓存刷新期间，数据库中的数据发生了变化。</span></span></li></ul><div id="https://www.notion.so/116a920890b180fa99cdde545c8c13a8" class="Divider"></div><div id="https://www.notion.so/116a920890b180099cc2fc86e2388b10" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">以上是非常常用的一Redis缓存更新方式，我们看到除了同步更新模式的一致性更好之外，其他的都存在明显的数据一致性问题。那么有没有其他的尽量保证一致性的方案呢？答案是有的。</span></span></p></div><h1 id="https://www.notion.so/116a920890b180fdbb17f85b40a525bf" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/116a920890b180fdbb17f85b40a525bf"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">5.延时双删</span></span></h1><div id="https://www.notion.so/116a920890b180898543f7c348b93f34" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2Fd5d0d7b1-d909-4ecd-983d-a8313b586e70%2F0019-%25E5%25BB%25B6%25E6%2597%25B6%25E5%258F%258C%25E5%2588%25A0.drawio.png?width=1232.5125732421875&amp;table=block&amp;id=116a9208-90b1-8089-8543-f7c348b93f34"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2Fd5d0d7b1-d909-4ecd-983d-a8313b586e70%2F0019-%25E5%25BB%25B6%25E6%2597%25B6%25E5%258F%258C%25E5%2588%25A0.drawio.png?width=1232.5125732421875&amp;table=block&amp;id=116a9208-90b1-8089-8543-f7c348b93f34" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/116a920890b1802bb606fb5e7c40714b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在更新数据时，应用在删除缓存和更新数据库之间引入延迟，执行两次缓存删除。</span></span></p></div><div id="https://www.notion.so/116a920890b1806fb6e3f60ef57d14e4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">流程</strong></span><span class="SemanticString">：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/116a920890b18037a59fc9b9e05f3361" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">更新数据库。</span></span></li><li id="https://www.notion.so/116a920890b180dfb619cebf5042b161" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">删除缓存。</span></span></li><li id="https://www.notion.so/116a920890b1806fa834ff778f303234" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">等待一定时间（例如几毫秒）。</span></span></li><li id="https://www.notion.so/116a920890b1800cb1a5ca8025cbc760" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString">再次删除缓存（即使它已经被更新）。</span></span></li></ol><div id="https://www.notion.so/116a920890b1803e8c95fae776dbd62f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">优点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b180a299b3e492f7ef7faf" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">大幅降低了缓存数据未同步到数据库时的读取不一致性。</span></span></li><li id="https://www.notion.so/116a920890b18060ad2bee01ee0e43f4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">对于高并发的场景，双重删除可以显著减少缓存不一致的机会。</span></span></li></ul><div id="https://www.notion.so/116a920890b180f4a555e6171e635e96" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">缺点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b18055bd37fa0433c480a6" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">增加了写操作的延迟。</span></span></li><li id="https://www.notion.so/116a920890b18030a4d9d94ebb8b9bb7" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">需要合理控制延迟时间，以防止引入过多的延迟或复杂性。</span></span></li></ul><h1 id="https://www.notion.so/116a920890b180de9f21e474b763e3f2" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/116a920890b180de9f21e474b763e3f2"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">6.分布式锁</span></span></h1><div id="https://www.notion.so/116a920890b1803f8d05edaafde07483" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/116a920890b1800387cef5c4f9b4dfc0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在执行更新操作时，通过分布式锁来确保在同一时间只有一个实例能对数据进行更新。</span></span></p></div><div id="https://www.notion.so/116a920890b1800eae8ae2d681441dee" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">流程</strong></span><span class="SemanticString">：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/116a920890b180158a37f9d21f15b397" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">获取分布式锁。</span></span></li><li id="https://www.notion.so/116a920890b180e0b685ce8bb135d045" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">更新数据库。</span></span></li><li id="https://www.notion.so/116a920890b18040b259ed1cf6d9c202" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">更新或删除缓存。</span></span></li><li id="https://www.notion.so/116a920890b1803182f9ff63e06befbe" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString">释放锁。</span></span></li></ol><div id="https://www.notion.so/116a920890b1805784cff01a50aef76a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">优点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b1803db1a7d4edb43019d9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">保证在高并发场景下数据一致性。</span></span></li><li id="https://www.notion.so/116a920890b18012bddbc7fed5d25bac" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">避免多个实例同时对同一数据进行写入，导致数据冲突。</span></span></li></ul><div id="https://www.notion.so/116a920890b180e39d23d742b1615003" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">缺点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b180108e25e6d3cb982d05" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">引入了额外的复杂性和性能开销。</span></span></li><li id="https://www.notion.so/116a920890b180fd9134cb34a3b23193" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">锁的管理不当可能导致死锁或性能瓶颈。</span></span></li></ul><h1 id="https://www.notion.so/116a920890b180c49296ecdde6a689ee" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/116a920890b180c49296ecdde6a689ee"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">7.事件驱动架构</span></span></h1><div id="https://www.notion.so/116a920890b18026bf17f18898bbe9ed" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">事件驱动架构如下：</span></span></p></div><div id="https://www.notion.so/116a920890b180f98b11d80e74a5fbdd" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2F75aaa8a3-55db-424f-b0a0-f23f4d60f2cc%2F%25E7%25AC%25AC9%25E7%25AB%25A0_%25E5%2583%258F%25E6%259E%25B6%25E6%259E%2584%25E5%25B8%2588%25E4%25B8%2580%25E6%25A0%25B7%25E5%25B7%25A5%25E4%25BD%259C-%25E4%25BA%258B%25E4%25BB%25B6%25E9%25A9%25B1%25E5%258A%25A8%25E6%259E%25B6%25E6%259E%2584.drawio.png?width=707.9750366210938&amp;table=block&amp;id=116a9208-90b1-80f9-8b11-d80e74a5fbdd"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2F75aaa8a3-55db-424f-b0a0-f23f4d60f2cc%2F%25E7%25AC%25AC9%25E7%25AB%25A0_%25E5%2583%258F%25E6%259E%25B6%25E6%259E%2584%25E5%25B8%2588%25E4%25B8%2580%25E6%25A0%25B7%25E5%25B7%25A5%25E4%25BD%259C-%25E4%25BA%258B%25E4%25BB%25B6%25E9%25A9%25B1%25E5%258A%25A8%25E6%259E%25B6%25E6%259E%2584.drawio.png?width=707.9750366210938&amp;table=block&amp;id=116a9208-90b1-80f9-8b11-d80e74a5fbdd" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/116a920890b1800bb154f022c33b0b24" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">使用消息队列或事件总线，在数据库更新时触发事件，异步地更新缓存。</span></span></p></div><div id="https://www.notion.so/116a920890b180d09faad1671a9d767d" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2F55ffb458-1f40-4c9c-ac6a-086bf173a35c%2F0019-%25E4%25BA%258B%25E4%25BB%25B6%25E9%25A9%25B1%25E5%258A%25A8%25E6%259B%25B4%25E6%2596%25B0%25E7%25BC%2593%25E5%25AD%2598.drawio.png?width=1232.5125732421875&amp;table=block&amp;id=116a9208-90b1-80d0-9faa-d1671a9d767d"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2F55ffb458-1f40-4c9c-ac6a-086bf173a35c%2F0019-%25E4%25BA%258B%25E4%25BB%25B6%25E9%25A9%25B1%25E5%258A%25A8%25E6%259B%25B4%25E6%2596%25B0%25E7%25BC%2593%25E5%25AD%2598.drawio.png?width=1232.5125732421875&amp;table=block&amp;id=116a9208-90b1-80d0-9faa-d1671a9d767d" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/116a920890b1801daff5f0c3938066b4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">流程</strong></span><span class="SemanticString">：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/116a920890b180cab717f4f95fdc1f9f" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">更新数据库。</span></span></li><li id="https://www.notion.so/116a920890b180c88783cfc51ef484b6" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">发布数据更新事件到消息队列。</span></span></li><li id="https://www.notion.so/116a920890b180c1b344cc3a055b27f2" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">监听消息的缓存更新服务消费事件，并更新缓存。</span></span></li></ol><div id="https://www.notion.so/116a920890b180f6808cfe44ca01a2a1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">优点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b1806787fec23c9e01f220" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">通过异步处理降低了数据库写入的延迟。</span></span></li><li id="https://www.notion.so/116a920890b180edb7b5e2cd57eb835d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">系统扩展性好，能够处理高并发情况。</span></span></li></ul><div id="https://www.notion.so/116a920890b1808190dcf4248ca8f940" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">缺点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b180829a7dc1dd44dc5fe1" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">实现复杂，需处理事件丢失或重复消费的情况。</span></span></li><li id="https://www.notion.so/116a920890b1807cbe16edb026134d37" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">事件消费延迟可能导致短期内数据不一致。</span></span></li></ul><h1 id="https://www.notion.so/116a920890b180febb63e46de3ada32a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/116a920890b180febb63e46de3ada32a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">8.版本号控制</span></span></h1><div id="https://www.notion.so/116a920890b1804eb0f6db1cc8b6a6de" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">为每个缓存数据增加版本号，每次更新数据时，检查版本号来决定是否更新缓存。</span></span></p></div><div id="https://www.notion.so/116a920890b180cd8921ddaf4f474ac9" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2F765f518b-7bd8-4a0e-b1b1-997c4ebfbead%2F0019-%25E7%2589%2588%25E6%259C%25AC%25E5%258F%25B7%25E6%258E%25A7%25E5%2588%25B6.drawio.png?width=707.9874877929688&amp;table=block&amp;id=116a9208-90b1-80cd-8921-ddaf4f474ac9"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2F765f518b-7bd8-4a0e-b1b1-997c4ebfbead%2F0019-%25E7%2589%2588%25E6%259C%25AC%25E5%258F%25B7%25E6%258E%25A7%25E5%2588%25B6.drawio.png?width=707.9874877929688&amp;table=block&amp;id=116a9208-90b1-80cd-8921-ddaf4f474ac9" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/116a920890b18063b2e1cde818befd90" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">流程</strong></span><span class="SemanticString">：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/116a920890b180e4a75ae5fa3cb3afa4" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">查询当前数据版本。</span></span></li><li id="https://www.notion.so/116a920890b180929ea7da29b8ce865f" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">更新数据库时，版本号加1。</span></span></li><li id="https://www.notion.so/116a920890b180db9e2ddf2338918402" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">如果缓存中存储的版本号与数据库不一致，则更新缓存。</span></span></li></ol><div id="https://www.notion.so/116a920890b180e7b553d74ef864c615" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">优点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b1803cbdfae36e76ccd0cc" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">通过版本号控制，可以有效降低缓存不一致的问题。</span></span></li><li id="https://www.notion.so/116a920890b180ae9f61d7cfff87e3ce" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">适合高并发场景，可以减少无效的缓存更新。</span></span></li></ul><div id="https://www.notion.so/116a920890b1808294ffd7cfe18432ce" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">缺点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b180ff8fa7ca51603ba23d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">需要额外的版本控制逻辑，增加了实现复杂性。</span></span></li><li id="https://www.notion.so/116a920890b18078b2f3d7878a2f4a86" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">在高并发情况下，可能导致版本号冲突。</span></span></li></ul><h1 id="https://www.notion.so/116a920890b1808998d7c0897b303a87" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/116a920890b1808998d7c0897b303a87"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">9.双写</span></span></h1><div id="https://www.notion.so/116a920890b180bfb5addeef251d6173" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">这个方案和【2.同步更新模式（Write Through）】中的模式是一样的，同时更新数据库和缓存，并确保二者在同一时刻的一致性，只不过这里强调两个动作组成的原子性，即通过事务来保证。</span></span></p></div><div id="https://www.notion.so/116a920890b18075af69eb8af63d89cd" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2Fe5f8091e-f0c5-498f-9ddd-77bf8ef0a7ea%2F0019-%25E5%258F%258C%25E5%2586%2599.drawio.png?width=1232.5125732421875&amp;table=block&amp;id=116a9208-90b1-8075-af69-eb8af63d89cd"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F333b4f28-5127-4daf-8c39-ec7700f99e1b%2Fe5f8091e-f0c5-498f-9ddd-77bf8ef0a7ea%2F0019-%25E5%258F%258C%25E5%2586%2599.drawio.png?width=1232.5125732421875&amp;table=block&amp;id=116a9208-90b1-8075-af69-eb8af63d89cd" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/116a920890b1800e9e30d418b7eadef7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">流程</strong></span><span class="SemanticString">：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/116a920890b180768b6eef8330a70a72" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">在事务中同时写入缓存和数据库。</span></span></li><li id="https://www.notion.so/116a920890b180a286d0ea3d97ee0805" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">只有在二者都成功时，提交事务。</span></span></li></ol><div id="https://www.notion.so/116a920890b180cb8198e138b7324f03" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">优点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b1807a8c78f475b3525456" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">能够保证数据的一致性。</span></span></li><li id="https://www.notion.so/116a920890b1800eb63ccce5db3fea0b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">对于少量数据写入操作，这种方法非常有效。</span></span></li></ul><div id="https://www.notion.so/116a920890b180ed8ef2c91a58fa9e3a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">缺点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b180e8bc85ceda08bfc8de" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">复杂性高，特别是在分布式系统中。</span></span></li><li id="https://www.notion.so/116a920890b180a49d40da8e4aa19931" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">事务处理可能引入性能瓶颈。</span></span></li></ul><h1 id="https://www.notion.so/116a920890b180bfac65e2ef64a424a4" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/116a920890b180bfac65e2ef64a424a4"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">10.</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">最终一致性</strong></span></span></h1><div id="https://www.notion.so/116a920890b180f6bd19e88d4ab2be93" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在不要求严格一致性的情况下，采用最终一致性策略，允许短期内的不一致，系统会通过后续的同步过程恢复一致性。</span></span></p></div><div id="https://www.notion.so/116a920890b180c5b16bc0c38b17ec32" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">优点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b180c88f0cd17b3c1f0edb" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">可以提高系统的可用性和性能。</span></span></li><li id="https://www.notion.so/116a920890b18038a2fee683a82c0c9f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">对于一些业务场景，最终一致性是可以接受的。</span></span></li></ul><div id="https://www.notion.so/116a920890b18064a0fce016cc4be8fa" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">缺点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/116a920890b180569069d41a1442e83e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">需要合理设计一致性恢复的逻辑。</span></span></li><li id="https://www.notion.so/116a920890b1806b8a88f623f546c7b4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">业务逻辑复杂度增加。</span></span></li></ul><h1 id="https://www.notion.so/116a920890b18035811fd6a6f6bf96c6" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/116a920890b18035811fd6a6f6bf96c6"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">总结</span></span></h1><div id="https://www.notion.so/116a920890b18077ae12f17b63a8b57d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">选择适合的策略取决于你的具体场景、业务需求和系统架构。结合这些策略，可以实现更高效的数据更新和一致性维护。</span></span></p></div><div id="https://www.notion.so/116a920890b1808e8d7dd5030ddd9366" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></article>
  <footer class="Footer">
  <div>&copy; 锡安的自留地 2024</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>

</body>

</html>