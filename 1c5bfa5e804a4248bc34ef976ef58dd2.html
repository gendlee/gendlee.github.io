<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🦜&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>0009 一种分布式事务的落地实践方案&nbsp;|&nbsp;李正的自留地</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="0009 一种分布式事务的落地实践方案">
  
    <meta name="description" content="本博客是基于国外的一篇saga论文，结合当前分布式技术，做的一次深入的分布式事务实践研究，写了近一个月。">
    <meta property="og:description" content="本博客是基于国外的一篇saga论文，结合当前分布式技术，做的一次深入的分布式事务实践研究，写了近一个月。">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🌋&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🦜&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="e48d9ceebf4c4de2b657c3a3d1d308f4.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;☀️&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>工具</span>
        </div>
      </a>
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🎏&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>关于我</span>
        </div>
      </a>
    
  
</nav>
  <header class="Header">
    
      <div class="Header__Cover">
        <img src="https://www.notion.so/images/page-cover/gradients_3.png">
      </div>
    
    <div class="Header__Spacer ">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🌋&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">0009 一种分布式事务的落地实践方案</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Tue, May 10, 2022</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--blue">
            <a href="tag/分布式事务.html">分布式事务</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--pink">
            <a href="tag/saga.html">saga</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--red">
            <a href="tag/解决方案.html">解决方案</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/1c5bfa5e804a4248bc34ef976ef58dd2" class="PageRoot"><div id="https://www.notion.so/6e28b4883b234b179679fe8bb8837409" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">🤺</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">本文是基于SAGA分布式事务论文的实现。</span></span></p></div><h1 id="https://www.notion.so/08b62310b2c74b13855e2c5512a25b9b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/08b62310b2c74b13855e2c5512a25b9b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">1、缩略语和关键术语定义</span></span></h1><div id="https://www.notion.so/9a121f0f19084677a0649762140ac154" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">MQ（Message Queue，消息队列）：在消息的传输过程中保存消息的容器。</span></span></p></div><div id="https://www.notion.so/7857fc32da9d40178c7fe37cdcedc9c2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ACID（Atomicity原子性、Consistency一致性、Isolation隔离性、Durability持久性的缩写）：指数据库管理系统在写入或更新资料的过程中，为保证事务是正确可靠的，所必须具备的四个特性。</span></span></p></div><div id="https://www.notion.so/6615780c54df4b5d943bdd0214e3cbec" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">BASE（Basically Available基本可用、Soft State软状态、Eventually Consistent最终一致性的缩写）：是指分布式应用无法做到强一致，但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性。</span></span></p></div><h1 id="https://www.notion.so/e952fe1d17394279900d31631fa25af2" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/e952fe1d17394279900d31631fa25af2"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2、背景技术方案</span></span></h1><h2 id="https://www.notion.so/6924b68744994ad2aa729ff97f3299c0" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/6924b68744994ad2aa729ff97f3299c0"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2.1 详细介绍背景技术方案</span></span></h2><div id="https://www.notion.so/43446a37cc98480d9469c4df34d69504" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">事务是指由一个或多个资源管理操作构成的操作序列，它具有原子性、一致性、隔离性和持久性，即ACID特征。分布式事务是指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上。对一致性时效要求不是特别高的场景，通常使用柔性事务（满足BASE特征）替代严苛的刚性事务（满足ACID特征），即不追求数据的强一致性保证其最终一致性。随着当前的数据库几乎都已支持事务，这使得单个服务节点具备事务能力（即本地事务）已逐渐成为标配。目前许多分布式柔性事务都是基于本地事务，主要代表为消息事务方式。</span></span></p></div><div id="https://www.notion.so/6d6e27aea796458da33a02a4e1c008de" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/d22e9007bb844b6ea74fc348dd8ed420" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">消息事务方式是将业务数据和本地事务状态共同存放到本地数据库，同时提供本地事务状态的查询接口。请求方先预提交请求，然后执行本地事务，事务成功则再次提交确认，MQ将消息传递给订阅方，若事务执行失败MQ将丢弃预提交请求。下图所示为消息事务的流程，具体步骤如下：                                          </span></span></p></div><div id="https://www.notion.so/a07603428b4641e89a391da8ab1d8608" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F0e3270a5-3f42-4b18-bd0c-a3eebb1f9378%2F%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8-%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%E5%AE%9E%E7%8E%B0.drawio_(1).png?width=1564&amp;table=block&amp;id=a0760342-8b46-41e8-9a39-1da8ab1d8608"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F0e3270a5-3f42-4b18-bd0c-a3eebb1f9378%2F%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8-%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%E5%AE%9E%E7%8E%B0.drawio_(1).png?width=1564&amp;table=block&amp;id=a0760342-8b46-41e8-9a39-1da8ab1d8608" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/d16a481baf7f47848d2165698e7c2fb8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S101：消息请求方先将请求提交到MQ，但MQ暂不能投递该消息，需要收到发送方对该消息的二次确认才会投递。这种被标记成“暂不能投递”状态的消息，又叫半消息，通常采用RocketMQ来处理这种特殊消息；</span></span></p></div><div id="https://www.notion.so/b04b0a50ee3b4a65b4411dc6b609d04d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S102：MQ向消息发送方确认消息是否接收成功；</span></span></p></div><div id="https://www.notion.so/7ea9ddf3c1c94484a93f4e2c39c91cf2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S103：消息请求方收到S102的确认后，执行本地事务，更新本地事务状态为成功或失败；</span></span></p></div><div id="https://www.notion.so/8775f5bcba5443a0b2e5f5e231f868b3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S104：若本地事务执行成功，则再次向MQ确认提交，反之则告知MQ已提交的消息需要回滚；</span></span></p></div><div id="https://www.notion.so/39e50537e9ae4c06a5bce334b87214bd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S105：若MQ未收到S104步骤的消息，将回查消息请求方的本地事务状态查询接口，判断事务执行成功还是失败；</span></span></p></div><div id="https://www.notion.so/97004e53159c4f70bd9a59fc93fa120a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S106：消息请求方查询本地事务执行状态，根据事务状态选择提交确认还是回滚；</span></span></p></div><div id="https://www.notion.so/3ed7555891b9483f9411e52f0198d0e8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S107：将提交确认或回滚消息发送给MQ；</span></span></p></div><div id="https://www.notion.so/6e0de055a09d41208aaacefe94f91d63" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S108：若是提交确认，MQ将消息投递给消息订阅方；</span></span></p></div><div id="https://www.notion.so/423d57cf73b64483b7b67329f019dcc2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S109：若是回滚消息，MQ将S101预提交的消息丢弃。</span></span></p></div><div id="https://www.notion.so/4f377600c81448a6bb9990f94c87f487" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/d8d762d13954473f80e12e73d1d49346" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">从以上步骤可知，消息事务其实是通过本地事务来保证分布式事务的，且依赖具备半消息处理能力的RocketMQ。从示意图可以看到，本地事务数据和业务数据是耦合在一起，且由服务节点各自管理，一旦本地事务数据丢失或不可用，整个事务将无法回滚。</span></span></p></div><h2 id="https://www.notion.so/a70129b1806d46d28fa2aa7bc9e8ffab" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/a70129b1806d46d28fa2aa7bc9e8ffab"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2.2 本技术要解决的技术问题</span></span></h2><div id="https://www.notion.so/23bcb1cccba34900af57990d147931bf" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">1）、该分布式事务方案依赖特殊的MQ，不具备很好的通用性和移植性。</span></span></p></div><div id="https://www.notion.so/665c5e7baa634652a098d352a9111652" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">2）、事务数据与业务数据高耦合，致使事务的独立自治变得困难。</span></span></p></div><div id="https://www.notion.so/65ea3bb30c5e4d49bc571bb8d739fa84" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">3）、事务一旦失败就立即回滚，缺乏合理的重试机制。</span></span></p></div><h1 id="https://www.notion.so/3ceeac6549f64dc5bea9417aed4e8276" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/3ceeac6549f64dc5bea9417aed4e8276"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">3、技术的创新点</span></span></h1><div id="https://www.notion.so/2b4325f2d3104da6af8f5e1258e350cd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">1）、设计了一种分布式事务协调管理器，不依赖MQ特性，对事务数据独立自治，通过插拔式的接口实现通用性。</span></span></p></div><div id="https://www.notion.so/cda00ee6b9c841f0b80df9070f342fd0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">2）、设计了一种基于决策矩阵的事务调度算法。</span></span></p></div><div id="https://www.notion.so/80fa262cbe574cb0be955a44e276b1a3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">3）、通过合理重试失败事务，提升分布式事务的执行成功率。</span></span></p></div><h1 id="https://www.notion.so/e9b0a30ef5574be4921ae0555e26cb5a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/e9b0a30ef5574be4921ae0555e26cb5a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">4、本技术方案及有益效果</span></span></h1><h2 id="https://www.notion.so/9f4ac1db6d4a4f42a2048bab545461b5" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/9f4ac1db6d4a4f42a2048bab545461b5"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">4.1 分布式事务协调管理装置</span></span></h2><div id="https://www.notion.so/73660592c89844d185b2f16ce7509286" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">本技术设计了一种独立于服务节点、应用自治的插拔式分布式协调管理装置。对任意具有N个服务节点（编号从1到N）的分布式系统，每个服务节点都对应着一个本地事务和一个事务补偿操作，所有本地事务构成完整的分布式事务，即：</span></span></p></div><div id="https://www.notion.so/8a78cd9a0efe4eeabf5f890481c3d1a6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/ccbf4d5676424a2c8d20b899bd3b4872" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Math" data-latex="T=T1(C1)+T2(C2)+...+Ti(Ci)+...TN(CN)"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo>=</mo><mi>T</mi><mn>1</mn><mo stretchy="false">(</mo><mi>C</mi><mn>1</mn><mo stretchy="false">)</mo><mo>+</mo><mi>T</mi><mn>2</mn><mo stretchy="false">(</mo><mi>C</mi><mn>2</mn><mo stretchy="false">)</mo><mo>+</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo>+</mo><mi>T</mi><mi>i</mi><mo stretchy="false">(</mo><mi>C</mi><mi>i</mi><mo stretchy="false">)</mo><mo>+</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi>T</mi><mi>N</mi><mo stretchy="false">(</mo><mi>C</mi><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">T=T1(C1)+T2(C2)+...+Ti(Ci)+...TN(CN)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord">1</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord">2</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord">2</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault">i</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></span></span></span></p></div><div id="https://www.notion.so/dcadaf45f0e44fb7bb0181bf1d9336d4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/f86468598bc6438ca01252a238d114d3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">以上公示中的为全局分布式事务，表示第i个服务节点的本地事务及其对应的补偿操作。补偿操作本质就是事务回滚，对于具有本地事务的节点来说是天然具备的，因为在数据库层面事务与回滚几乎都能同时保证。即将节点的回滚操作封装到接口中，可由外部调用触发。</span></span></p></div><div id="https://www.notion.so/a6553f4cf3574a689cb38b1ee5100595" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fd07fa412-676b-4281-9b81-9f61d4d955e1%2F%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8-%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.drawio_(2).png?width=1366&amp;table=block&amp;id=a6553f4c-f357-4a68-9cb3-8b1ee5100595"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fd07fa412-676b-4281-9b81-9f61d4d955e1%2F%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8-%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.drawio_(2).png?width=1366&amp;table=block&amp;id=a6553f4c-f357-4a68-9cb3-8b1ee5100595" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/f35e1ac542b74c0ba9b9f843d8801e26" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">图1 可回滚和重试的分布式事务协调管理器</strong></span></span></p></div><div id="https://www.notion.so/c65293f1ad2a44bbb9543057ebe855ff" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">图1所示为本技术设计的分布式协调管理器（以下简称管理器），当用户请求进入服务节点后，会经过事务拦截器（如图2所示），拦截器将事务上报给管理器，节点执行完本地事务后，拦截器再次上报执行状态，整个过程对业务处理是无感的。当分布式中的某个节点事务执行失败，经管理器的决策算法判断是下发回滚还是重试指令，若是回滚会不断触发调用链上的节点进行回滚。其中，分布式节点的事务状态都由管理器存储、加工和计算，实现事务数据与业务数据的松散耦合。</span></span></p></div><div id="https://www.notion.so/baba9af196cb49ac81d9c85703dab8c7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">图2为事务拦截器的示意图，根据事务处理的事前、事中和事后原则进行设计，每个步骤的含义为：</span></span></p></div><div id="https://www.notion.so/6b413f0d0c614ae1b546a71c707b6a43" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S201：事前步骤，服务节点接受到服务请求，将事务初始化信息上报管理器；</span></span></p></div><div id="https://www.notion.so/86696cee347d4a14a09af8cfddf2b5d9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S202：事中步骤，该步骤为业务处理，执行对应的本地事务；</span></span></p></div><div id="https://www.notion.so/cfba87b118594aeb8152459767015386" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S203：事后步骤，本地事务执行完成后，拦截器将本地事务状态上报管理器。</span></span></p></div><div id="https://www.notion.so/72dd2aa6f099490e896db50b01070ea3" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F2e1f6e48-676b-415b-8068-00fe6ed49221%2F%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8-%E4%BA%8B%E5%8A%A1%E6%8B%A6%E6%88%AA%E5%99%A8.drawio.png?width=942&amp;table=block&amp;id=72dd2aa6-f099-490e-896d-b50b01070ea3"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F2e1f6e48-676b-415b-8068-00fe6ed49221%2F%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8-%E4%BA%8B%E5%8A%A1%E6%8B%A6%E6%88%AA%E5%99%A8.drawio.png?width=942&amp;table=block&amp;id=72dd2aa6-f099-490e-896d-b50b01070ea3" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/3857eb2fd1de4f71baeefa330aa82df3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">图2 事务拦截器装置结构图</strong></span></span></p></div><h2 id="https://www.notion.so/10f7dd175ae04479a281d24944227e10" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/10f7dd175ae04479a281d24944227e10"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">4.2 分布式事务协调管理过程</span></span></h2><div id="https://www.notion.so/cc3146b23d444cb68824112ce97a8447" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在上一节的装置结构基础上，本节主要介绍管理器的执行过程。图3所示为本技术的分布式事务协调管理过程：</span></span></p></div><div id="https://www.notion.so/3d044eb236704c66a84a013cf369984e" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F7ea05f68-5159-474a-97fd-c735f6a358f1%2F%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8-%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8%E8%AF%A6%E7%BB%86%E8%AE%BE%E8%AE%A1.drawio_(2).png?width=1358&amp;table=block&amp;id=3d044eb2-3670-4c66-a84a-013cf369984e"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F7ea05f68-5159-474a-97fd-c735f6a358f1%2F%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8-%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8%E8%AF%A6%E7%BB%86%E8%AE%BE%E8%AE%A1.drawio_(2).png?width=1358&amp;table=block&amp;id=3d044eb2-3670-4c66-a84a-013cf369984e" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/d2c9dc7126b64f5782d6327bbe022fa4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">图3 分布式事务协调管理执行过程</strong></span></span></p></div><div id="https://www.notion.so/0393179121a545a4bf465e49c01c57a8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S301：服务节点在接入统一的分布式事务管理之前，需要向管理器注册事务节点，提供本地事务的补偿方法接口；</span></span></p></div><div id="https://www.notion.so/7ea35fa568014f018938428f9c1edc07" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S302：管理器为该节点创建一个记录其事务状态的事务表，并生成全局唯一的事务ID值，该ID值与事务表名一一对应，目的是避免多节点共用同一张事务表出现性能问题。同时，管理器还会为补偿方法生成对应的补偿ID；</span></span></p></div><div id="https://www.notion.so/de0717b7b64a46db87bde5158ebe1dae" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S303：管理器创建事务表成功后，将对应的事务ID值分配给服务节点，至此完成事务管理服务的注册过程；</span></span></p></div><div id="https://www.notion.so/cb1255e707cc4617a4472faace24abfb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S304：当服务请求进入后，拦截器上报事务的初始状态，上传信息包括：当前服务节点ID、调用方服务节点ID、补偿接口ID；</span></span></p></div><div id="https://www.notion.so/a87e4af8e5e54b51b4f058033f96df93" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S305：管理器收到上报的事务后，根据唯一事务ID寻址对应的事务表，在事务表中插入一条初始化的事务数据，同时根据服务节点ID和调用方服务节点ID关系，利用Zipkin算法</span><span class="SemanticString">[1]</span><span class="SemanticString">生成分布式调用链路；</span></span></p></div><div id="https://www.notion.so/58d2ec5375c246d9ab31082106b198bd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S306：服务节点的本地事务执行步骤；</span></span></p></div><div id="https://www.notion.so/f68e1913ed5b4022af245505557441fb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S307：将本地事务执行的状态（成功或失败）上报管理器；</span></span></p></div><div id="https://www.notion.so/eed0c122845345169ba0c4f87292c78f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S308：通过管理器的调度算法决策，决定事务前向重试或后向补偿，同时更新对应事务流水的状态；</span></span></p></div><div id="https://www.notion.so/243927425c4c454b8e56db108ae73565" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S309：若本地事务是执行成功的，则流程将顺利执行到下一个服务节点；</span></span></p></div><div id="https://www.notion.so/39fc0860a03542c5bddcaea0aaa11865" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S310：若本地事务执行状态为失败，经决策需要后向补偿，根据管理器生成的分布式调用链，从该节点开始，执行后向事务补偿，若需要重试，则执行事务重试；</span></span></p></div><div id="https://www.notion.so/a95a835fe59b462ca90f6bd234fdf58e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S311：执行本地事务补偿，若补偿失败会不断重试直到成功，该步骤由人工干预兜底保证。如果是事务重试，则会重试一定次数再决定是否启动补偿。</span></span></p></div><div id="https://www.notion.so/1a7f4c11116a42a08a11b52cdb6ebc16" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S312：本地事务补偿成功后将结果上报管理器；</span></span></p></div><div id="https://www.notion.so/f9e7e2a2e6504b049e5246c44d493c33" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S313：管理器根据调用链，调度上一个服务节点，传送事务回滚的指令，重复S310-S312步骤直到所有补偿都完成则流程结束；</span></span></p></div><div id="https://www.notion.so/7802508b1b6948239f17bbe6a708874f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S314：本地事务重试成功，上报事务结果；</span></span></p></div><div id="https://www.notion.so/8dbab80b06214fd2b1bd92cb1a7e7c59" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S315：流程顺利执行到下一个服务节点。</span></span></p></div><div id="https://www.notion.so/3859762131de4022bbf2d37beb99c445" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/9f1b7052a72e448781d689333870b0ec" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">以上步骤可以总结为，服务节点要接入管理器，首先需要注册节点事务ID，有了这个ID则表示管理器将该节点的事务纳入统一管理。服务节点侧，当请求进入服务节点后，通过事务拦截装置先上报事务，节点执行完事务后再将执行结果上报。管理器侧，通过上报的事务执行结果决策整个事务应该回滚还是有限次数的局部重试，最终实现分布式事务的统一管理。</span></span></p></div><div id="https://www.notion.so/635a671a1fe44a798151a7265afe0618" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/b643fec5083d4b5ab44fd5f00da5b107" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">本技术以APP用户注销场景为例，将操作案例贯穿整个流程进行说明。假设有这样一个APP，用户注销账户时，须将用户的积分兑换为话费充值到用户的手机号，完成积分兑换清零后，才注销用户状态及删除必要的用户信息。具体的分布式服务流程如图4所示：</span></span></p></div><div id="https://www.notion.so/ae4f3966dc6d430bad3f5546cbe23811" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F0fe669a7-373e-4495-b54e-160dca841ba6%2F%E5%AE%9E%E4%BE%8B.png?width=1435&amp;table=block&amp;id=ae4f3966-dc6d-430b-ad3f-5546cbe23811"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F0fe669a7-373e-4495-b54e-160dca841ba6%2F%E5%AE%9E%E4%BE%8B.png?width=1435&amp;table=block&amp;id=ae4f3966-dc6d-430b-ad3f-5546cbe23811" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/6c6a1eb0c5b9450b963d0d9f8858770d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">图4 APP用户注销分布式调用流程</strong></span></span></p></div><div id="https://www.notion.so/afed153576284f7c85c6baa4330c7a68" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如图4中所示，注销流程共有5个分布式服务节点，用户发起的请求调用链按时间顺序为：[服务节点编号#5]-&gt; [服务节点编号#4]-&gt; [服务节点编号#3]-&gt; [服务节点编号#2]-&gt; [服务节点编号#1]，而分布式服务执行是调用链的逆过程，即图中所示的顺序。下面是对应流程：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/ef9ba6bf73a44f5b8190b7938e386688" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">为每个服务节点注册一个事务ID。比如充值话费服务节点，注册后由管理器分配的事务ID为0002，并为该节点创建事务表，本案例中事务表自动命名规则为：tx前缀+服务节点ID+事务ID。因此服务节点2的事务表名为：tx_2468_0002，该方式不仅保证了事务表的全局唯一性，管理器在路由寻表时也非常简单高效。</span></span></li><li id="https://www.notion.so/b7159bc88012421890ec96885380d814" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">服务节点向管理器提供服务补偿接口，管理器为其生成补偿接口ID，如节点3积分清零服务，提供了积分复原补偿接口。管理器为其生成的事务补偿ID为：0003001，即按事务ID+自增序号规则生成。</span></span></li><li id="https://www.notion.so/27b6afca88f344ea9c61b1674c2d52fe" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">用户点击注销账户，服务从左向右逐级驱动，以节点3积分清零服务为例，若服务成功，则管理器更新事务表tx_3089_0003中该条请求的状态为成功，流程走到节点4用户信息状态注销，假设该步骤失败，管理器更新事务表tx_3124_0004中该条请求状态为回滚中，同时调用节点4的回滚接口：0004001，若回滚成功成功（用户状态激活）则更新状态为补偿成功，并向节点3发送回滚指令。</span></span></li><li id="https://www.notion.so/0fb56ded24394c70b1ea0b73fa98f69f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">当节点4失败时，若经过决策矩阵判断可以重试3次，且重试过程中完成了服务，则流程顺利推进到节点5客户端本地用户表信息删除，若节点5执行成功，则完成账户注销流程。</span></span></li></ul><div id="https://www.notion.so/79350e5697d34e7a880cb92ef4175422" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">以上即为分布式事务协调管理的宏观过程，通过APP账户注销流程进行了演示说明。</span></span></p></div><h2 id="https://www.notion.so/1f80ded654af43b19910072bf33a40f8" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/1f80ded654af43b19910072bf33a40f8"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">4.3 分布式事务调度算法</span></span></h2><div id="https://www.notion.so/d435de81e636424aa8f0bf2a3f1a5719" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">本技术还设计了一种提高分布式事务成功率的事务调度算法，它内置于管理器装置，算法流程如图5所示。</span></span></p></div><div id="https://www.notion.so/17aaeb5366904926810f3e3c0b0932cc" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fae728720-1b9d-4c89-b168-a97a3b5e78ea%2F%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8-%E5%86%B3%E7%AD%96%E7%9F%A9%E9%98%B5%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8%E5%BC%95%E6%93%8E%E7%AE%97%E6%B3%95.drawio.png?width=1876&amp;table=block&amp;id=17aaeb53-6690-4926-810f-3e3c0b0932cc"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fae728720-1b9d-4c89-b168-a97a3b5e78ea%2F%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8-%E5%86%B3%E7%AD%96%E7%9F%A9%E9%98%B5%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8%E5%BC%95%E6%93%8E%E7%AE%97%E6%B3%95.drawio.png?width=1876&amp;table=block&amp;id=17aaeb53-6690-4926-810f-3e3c0b0932cc" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/c6210c35f4e84213ac8ee068114dbf14" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">图5 分布式事务调度算法流程图</strong></span></span></p></div><div id="https://www.notion.so/51aef554031745bd8af423dbdd50da66" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">假设分布式系统有N个服务节点，用i表示服务节点编号。流程开始后管理器监听节点i上报的事务，标记其事务状态为开始。节点i开始执行本地事务：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/a40b76cc2ac242f082c8f5ea292e64b0" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">若节点i的本地事务执行成功，管理器记录节点i的事务状态为成功，继续执行下一个节点（i=i+1），当所有节点都执行成功（i=N），流程结束；</span></span></li><li id="https://www.notion.so/8160404c7d1a46f4b02c8ece3d65d9b5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">若节点i的本地事务执行失败，则通过决策矩阵进行决策：</span></span></li></ul><ol class="NumberedListWrapper"><li id="https://www.notion.so/30426273f6d84c53b62f062a36260236" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">若决策结果为重试，则继续监听节点i并下发重试指令，该步骤对应图中的P1前向重试模块，该模块通过有限次数的合理重试，避免任务一失败就立即回滚，从而提升整个事务的成功率。</span></span></li><li id="https://www.notion.so/089925fe5ca044419517126f6e4efcd4" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">若决策结果为开启事务补偿，管理器记录节点i的状态为补偿开始，并下发补偿指令，节点i开始执行自己的补偿操作，若执行成功，更新节点i的事务状态为补偿成功，并调度下一个节点（i=i-1），直到所有节点都已完成补偿（i=0），整个分布式事务得以回滚。当然，补偿操作不一定一次就能执行成功，如果补偿失败，需要系统自动重试，如果重试超过配置的次数，需加入告警，由人工干预来保证节点的补偿执行成功。整个步骤对应图中的 P2后向补偿模块。</span></span></li></ol><div id="https://www.notion.so/496425e01e9547d392e2b477af79f704" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在以上调度算法中，决策矩阵是一个重要的创新点，本技术中提出的决策矩阵的设计如图6所示：</span></span></p></div><div id="https://www.notion.so/3d0b4c584c5f452c8e705a60e4b47164" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F04afcddd-6d4f-4525-a29d-c44cf1cf0890%2F%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8-%E9%87%8D%E8%AF%95%E5%86%B3%E7%AD%96%E7%9F%A9%E9%98%B5.drawio_(3).png?width=1982&amp;table=block&amp;id=3d0b4c58-4c5f-452c-8e70-5a60e4b47164"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F04afcddd-6d4f-4525-a29d-c44cf1cf0890%2F%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8-%E9%87%8D%E8%AF%95%E5%86%B3%E7%AD%96%E7%9F%A9%E9%98%B5.drawio_(3).png?width=1982&amp;table=block&amp;id=3d0b4c58-4c5f-452c-8e70-5a60e4b47164" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/0a9be40bf67b475da25983ebb43a59f8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">图6 决策矩阵</strong></span></span></p></div><div id="https://www.notion.so/c2a2b6cc829c4a8188165b1c1a6b1b49" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在决策矩阵中，第一列表示节点事务执行失败时的要素，第二、三列表示对应的选择：回滚或重试，第三、四列为重试时的可选方案和对应的可配置的最大重试次数（R1-R5）。重试最大次数R1-R5通常是根据实际生产运行监控数据总结出的经验值。决策矩阵中的各项内容为：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/2bdeb2b0ec5d4273863b4067ac8ba390" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">当出现业务层的参数错误时，这种场景通常重试是无法完成服务的，因此及时回滚并抛出异常，让用户根据错误纠正输入才是更加明智的做法；</span></span></li><li id="https://www.notion.so/c6f4a6c4b6f343b7b0f9c520d5749a56" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">写数据库失败，对于多实例的服务，可以将请求转发到同构化的节点上帮忙处理，也可以在本地节点定时重试；</span></span></li><li id="https://www.notion.so/48313e4fb38947a0b33ace6fc06583bf" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">读数据库失败，对于主从结构的数据库，通常遵循“写主读从”的模式，如果当前的从节点读数失败，可自动切换读取其他从节点，直到读取到相同的数据副本，也可以本地节点定时重试；</span></span></li><li id="https://www.notion.so/3243c72d3d454df1b129ce6b70c4ab96" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">网络异常，首先采用本地节点重试，如果重试一定次数后仍不成功，可将请求转发到其他节点，不断轮询可提供服务的节点；</span></span></li><li id="https://www.notion.so/e85b6c63a5e64366a66ff483ddac94f1" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">服务超时，除了实例宕机这种特殊情况外，更可能的情况是请求积压导致超负荷，此时如果继续在当前节点重试，只能增大负荷，情况会更加恶化。因此可以采用指数退避（Exponential Backoff）方式重试，即重试的时间间隔呈指数增长。若仍然失败，可转发到同构的服务节点去尝试处理，但在负载均衡正常的情况下，其他节点的请求量也不一定少，因此只能作为一种备选方案去尝试；</span></span></li><li id="https://www.notion.so/5791b304ad234291ba3137666bc0a7a1" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">当前节点无补偿接口时，若流程跨过该节点后一旦出现回滚，将在此处出现回滚断点，整个分布式回滚将失败。因此分布式链路上如果存在无补偿接口的节点，优先考虑提供补偿接口，若不能提供，服务在该节点及其之前发生失败时，都应该选择回滚。比如图4中节点2充值话费服务，所依赖的第三方接口如果不支持撤销支付，一旦流程越过节点2则无法回滚到节点1。因此在节点1或节点2执行失败，都应该优先回滚；</span></span></li><li id="https://www.notion.so/dea9bfea44844d40ae474d068af03605" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">调用链路均有补偿接口的情况，若失败节点在调用链路上的位置已经过半，此时优先选择重试，可以是本地重试也可以是转发重试。比如用户注销时，执行流程在节点4失败，由于此时执行链路已经过半，应优先选择重试；</span></span></li><li id="https://www.notion.so/5887960949b24f02a525bf7cffe8c60d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">如果该服务节点允许有损服务，可选择本地重试也可以服务降级通过。比如用户注销时，目的是将用户的积分兑换为话费为用户充值，以提高用户对APP的好感度，如果话费充值成功但积分清零步骤失败，由于可通过用户状态来判断未清零的积分是否有效，因此该失败步骤可选择降级通过，从而提升成功率。</span></span></li></ul><h2 id="https://www.notion.so/c567771441c548debf8892a742a0ca02" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/c567771441c548debf8892a742a0ca02"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">4.5 分布式事务装置</span></span></h2><div id="https://www.notion.so/5a1472697c204fdb8dc778afad483307" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">本技术的分布式事务装置的全局结构如图7所示，每个模块的功能为：</span></span></p></div><div id="https://www.notion.so/66d76788fca84205ba49d2216234dde1" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F971e4fbc-2aa5-4586-80d4-bb073cf25e35%2F%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E8%A3%85%E7%BD%AE.drawio.png?width=1342&amp;table=block&amp;id=66d76788-fca8-4205-ba49-d2216234dde1"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F971e4fbc-2aa5-4586-80d4-bb073cf25e35%2F%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E8%A3%85%E7%BD%AE.drawio.png?width=1342&amp;table=block&amp;id=66d76788-fca8-4205-ba49-d2216234dde1" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/d394ff9ad2c34d92b0e1b713fe4b1817" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">图7 分布式事务协调管理装置结构图</strong></span></span></p></div><div id="https://www.notion.so/57db7e26afae4aa49e8fc0a049fff86e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S401：监听单元，管理器负责监听服务节点上报事务的功能单元；</span></span></p></div><div id="https://www.notion.so/88aa938fcfbe4bdba85c2cfd92062dc7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S402：通信接口单元，负责管理器与分布式集群之间的数据通信；</span></span></p></div><div id="https://www.notion.so/258deed911f34f42aec873788bd0c62e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S403：事务上报单元，负责事务执行前后的拦截上报；</span></span></p></div><div id="https://www.notion.so/2e2129657ffc490582823321239aae89" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S404：用户接口，提供给服务节点的插拔式接口；</span></span></p></div><div id="https://www.notion.so/d946d08a8580443a9c6eb6c1a1a510a8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S405：事务指令执行单元，接受到管理器的事务执行指令（补偿或重试）后，由该单元负责执行；</span></span></p></div><div id="https://www.notion.so/b7df02459e9246969600f38d5076c459" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S406：指令单元，管理器根据决策结果，生成调度指令，对应的指令集如图8所示。指令集共有六种指令，覆盖了回滚/重试当前节点、回滚/重试指定服务节点、停止回滚/重试一定的时间，指令的使用示例如表中最后一列所示。</span></span></p></div><div id="https://www.notion.so/c8d4712839cd4176a1d27a121a02a5fe" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fcc179f3b-e3d3-4c7a-8479-fd888b7cc330%2F%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8-%E6%8C%87%E4%BB%A4%E9%9B%86.drawio.png?width=1722&amp;table=block&amp;id=c8d47128-39cd-4176-a1d2-7a121a02a5fe"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fcc179f3b-e3d3-4c7a-8479-fd888b7cc330%2F%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%B0%83%E7%AE%A1%E7%90%86%E5%99%A8-%E6%8C%87%E4%BB%A4%E9%9B%86.drawio.png?width=1722&amp;table=block&amp;id=c8d47128-39cd-4176-a1d2-7a121a02a5fe" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/cb5b0548707c4f0da1c2df43f9a72d1a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">图8 分布式事务调度指令集</strong></span></span></p></div><div id="https://www.notion.so/a001a0bde46847399370140436e7eea7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">以用户注销场景为例，当节点2充值话费服务失败，管理器发送的指令如下：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/038cf452aa7546f2ade89607012d5081" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">{“cmd”:“ROLLBACK”}，管理器根据请求中携带的节点ID（2468），指定节点2的所有补偿接口都执行回滚，即回滚当前节点事务；</span></span></li><li id="https://www.notion.so/c2b52ff274f54c5cbb865cf258ddcb59" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">{“cmd”：“RETRY”}，管理器根据请求中携带的节点ID（2468），指定节点2重试，即重试当前节点；</span></span></li><li id="https://www.notion.so/3ebd4ef1121346df8b52621da3efd672" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">{“cmd”: “ROLLBACK_WITH_SERVICE_ID”，“service_id”: “2468”，“rollback_id”：[“0002001”，“0002002”]}，管理器指定节点2执行撤销充值（0002001）和撤销支付（0002002）补偿操作。该命令可以细化补偿接口的粒度，通过rollback_id列表来指定必要的补偿操作；</span></span></li><li id="https://www.notion.so/27d7822deeb14c8a81f7a251f7492eeb" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">{“cmd”: “RETRY_WITH_SERVICE_ID”，“service_id”: “2468” }，管理器指定节点2468执行重试；</span></span></li><li id="https://www.notion.so/45906009c7384bfa9083662aaa488c07" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">{“cmd”: “PAUSE_RETRY_SECOND”，“time”: “60” }，该命令用于控制重试时间，避免超时。比如用户注销时前端提示10分钟内完成注销，但是由于节点重试时间太久，导致注销超时。为了避免这一场景，需要限定重试允许的最大时间；</span></span></li><li id="https://www.notion.so/af788204efe44dfead45cfcaf654fc94" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">{“cmd”: “PAUSE_ROLLBACK_SECOND”，“time”: “60” }，该命令用于指定回滚允许的最大时间，如果超时则先告知用户注销失败，然后通过定时任务来兜底完成回滚。</span></span></li></ul><div id="https://www.notion.so/4f80c3e1a9894439b1496b2d05dd10a5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S407：事务注册器，管理器中负责服务节点事务管理注册的单元；</span></span></p></div><div id="https://www.notion.so/60b49c5f9d9143f1a660e46dc506221b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S408：处理器，指中央处理器CPU，负责管理器的计算任务；</span></span></p></div><div id="https://www.notion.so/ec6ac05547da4d538813daa8e99b8306" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S409：调度引擎，内置了本技术的调度算法，负责实时决策事务节点的调度任务；</span></span></p></div><div id="https://www.notion.so/fbff46d8b5f64457b89c30e44b2cbca5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">S410：存储器，用于管理器中的数据存储，包括但不限于关系型数据库、非关系型数据库以及磁盘日志文件。</span></span></p></div><div id="https://www.notion.so/e2a06e1c0df94aeea8305b15077e75be" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">通过上述的管理过程、调度算法、管理装置、调度指令等一系列的技术设计，可以实现一套可方便移植、应用自治、成功率高的分布式柔性事务解决方案。</span></span></p></div><h1 id="https://www.notion.so/582548238dcb44e9b93edefe8bca1248" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/582548238dcb44e9b93edefe8bca1248"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">5、最优方案的有益效果</span></span></h1><div id="https://www.notion.so/2c464943e036411a9ba7c3b2de10f4fb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">（1）通过本技术的分布式协调管理器，可以实现事务处理与业务处理的解耦，这种插拔式的管理器技术栈无关，具有通用性。</span></span></p></div><div id="https://www.notion.so/42ed7e4ae1cd4c1ebdde88ab12063f4d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">（2）通过本技术的分布式事务调度算法，能提升分布式事务的成功率。</span></span></p></div><div id="https://www.notion.so/ef13aac62a9840309a3d1fab2bfd13e8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">（3）从服务节点单独管理事务数据，变为由管理器统一管理，避免了节点管理的事务数据不可用时全局事务的不可回滚。</span></span></p></div><h1 id="https://www.notion.so/5a2e14be210f4262af2a3a564864387f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/5a2e14be210f4262af2a3a564864387f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">6、本技术的替代方案</span></span></h1><div id="https://www.notion.so/5b8acaee818346d38053131c5475b37d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">（1）本技术的分布式事务协调管理器，它是基于服务节点具有事务补偿能力，因此还有一种替代方案：</span></span></p></div><div id="https://www.notion.so/026501e6fdc44bef8d0138ba8d92910d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果分布式系统中存在没有事务补偿能力的服务节点，为了提高分布式事务的执行成功率，在服务编排时，应尽量将具有本地事务补偿能力的节点安排在前面。对于没有本地事务补偿能力的节点，管理器可采用数据库快照方式（数据量最小化），记录节点数据库业务执行前的状态，生成回滚日志（即undo log）。当需要回滚没有事务补偿能力的节点时，由管理器代为补偿执行。</span></span></p></div><div id="https://www.notion.so/7693b9f4f8aa425c8ada9e9920ee3596" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">（2）对于本技术中使用的事务拦截器，可用过滤器或java 中的切面技术代替。</span></span></p></div><div id="https://www.notion.so/a67fde52294b44af89027f2072716e59" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">（3）对于决策矩阵中“调用链路节点均有补偿接口，且链路已过半”情况，对应的条件为i&gt;N/2，其中i为节点编号（1到N），N为服务节点个数。除了i&gt;N/2外，还可以根据后续节点的可用率均值进行调整，如果后续节点的可用率均值都比较高，条件可放宽到i&gt;N/3、i&gt;N/4等，依次类推。</span></span></p></div><h1 id="https://www.notion.so/b9e3a640e63a453aa80c77b323e660ed" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/b9e3a640e63a453aa80c77b323e660ed"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">7、参考文献</span></span></h1><div id="https://www.notion.so/ddc2fee8033d42e1ac40009cc4cc6645" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">[1] jcchavezs. Openzipkin分布式链路生成算法[EB/OL]. https:// github.com/openzipkin/zipkin,2018-1-25/2022-02-02.</span></span></p></div><div id="https://www.notion.so/a29bfde506f5403ebac878c8e316495e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">[2] https://microservices.io/patterns/data/saga.html</span></span></p></div><div id="https://www.notion.so/088a5285206b415eaccb36a1042afbb7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">[3] </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="http://servicecomb.incubator.apache.org/cn/docs/distributed-transactions-saga-implementation/">http://servicecomb.incubator.apache.org/cn/docs/distributed-transactions-saga-implementation/</a></span></span></p></div><div id="https://www.notion.so/34843f233eae48abb2001ffca4ecd29c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">[4] </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.cs.cornell.edu/andru/cs711/2002fa/reading/sagas.pdf">https://www.cs.cornell.edu/andru/cs711/2002fa/reading/sagas.pdf</a></span></span></p></div></article>
  <footer class="Footer">
  <div>&copy; 李正的自留地 2024</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>

</body>

</html>