<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🦜&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>0004 MySQL中反人类的NULL&nbsp;|&nbsp;李正的自留地</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="0004 MySQL中反人类的NULL">
  
    <meta name="description" content="MySQL中的NULL值得敬畏，如果认知不是很清晰，容易踩到坑，甚至发生生产问题。">
    <meta property="og:description" content="MySQL中的NULL值得敬畏，如果认知不是很清晰，容易踩到坑，甚至发生生产问题。">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;⚰️&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🦜&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>回到主页</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="e48d9ceebf4c4de2b657c3a3d1d308f4.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;☀️&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>工具</span>
        </div>
      </a>
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🎏&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>关于我</span>
        </div>
      </a>
    
  
</nav>
  <header class="Header">
    
      <div class="Header__Cover">
        <img src="https://www.notion.so/images/page-cover/nasa_wrights_first_flight.jpg">
      </div>
    
    <div class="Header__Spacer ">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;⚰️&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">0004 MySQL中反人类的NULL</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Sat, Jan 22, 2022</span>
        
        
      </div>
    
  </header>
  <article id="https://www.notion.so/04a86b39bd2c41978640a5d57b7a6543" class="PageRoot"><blockquote id="https://www.notion.so/ffdcfba64db846979bf99b6078cf991f" class="ColorfulBlock ColorfulBlock--ColorBlue Quote"><span class="SemanticStringArray"><span class="SemanticString">本文是新人第一次在KM上发表的文章，记录踩MySQL NULL值的坑及学习总结。本文写作目的有二：其一，从坑中倒逼自己复盘根因，消除知识盲区，养成敬畏每一个技术细节的意识；其二，用自己吃的一堑，涨他人一智，也算是一种“贡献”。当然，这是一个开发新手的总结，能力有限，若有纰漏，还请指正。</span></span></blockquote><h1 id="https://www.notion.so/f3a7db0d9e0e4aff871f8e9cfa6c5f78" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/f3a7db0d9e0e4aff871f8e9cfa6c5f78"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen">1.MySQL中的NULL是什么？</mark></span></span></h1><div id="https://www.notion.so/fdbc3de908ab4d589a95cbcb591ff285" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">以下是引自</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.mysqlzh.com/doc/88/284.html">MySQL官方文档</a></span><span class="SemanticString">中对NULL值的定义：</span></span></p></div><blockquote id="https://www.notion.so/02a93bc71a3f473a9b7760e2c45447e3" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">NULL值表示“没有数据”。NULL可以写成大写或小写。请注意NULL值不同于数字类型的0或字符串类型的空字符串</span></span></blockquote><div id="https://www.notion.so/66cdb02ce48b4171bd6866ddfc01a0f8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">上述定义，如果我们用不同形状来表示不同性质的物体，可以表示成：</span></span></p></div><div id="https://www.notion.so/0e6dade0296a4f8ea24798dc7f07aab5" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fdaa5df35-9fca-4e62-97d3-83242534ed63%2F%E6%97%A0%E6%A0%87%E9%A2%98-2021-10-07-2117.png?width=1178&amp;table=block&amp;id=0e6dade0-296a-4f8e-a247-98dc7f07aab5"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fdaa5df35-9fca-4e62-97d3-83242534ed63%2F%E6%97%A0%E6%A0%87%E9%A2%98-2021-10-07-2117.png?width=1178&amp;table=block&amp;id=0e6dade0-296a-4f8e-a247-98dc7f07aab5" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/d9b42043ade74b698b6a0b5c9e96b427" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">也就是说在MySQL中NULL（null），作为一个独立的个体，是区别于数值0以及空字符串的。那么为什么作为开发人员，我们会潜意识的把它们混在一起呢？这里一定存在一些历史经验的原因，这个原因，我大致总结为以下几点：</span></span></p></div><div id="https://www.notion.so/5a4927fa121e4442a922a7af4ca03ec4" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">1️⃣</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">C/C++语言的习惯。对于我们大多数人，大学第一门计算机语言课当属C/C++语言，在这类语言中，NULL与0确实存在着某种等价关系，我们扒一下</span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">stdio.h</em></span><span class="SemanticString">中空指针的源码，会发现有如下定义：</span></span></p></div><pre id="https://www.notion.so/36b9bf33821346498f1fc2fdd4b184d2" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">defined</span><span class="token punctuation">(</span>__NEEDS_NULL<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NULL</span>    <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NULL</span>    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span></span></span></code></pre><div id="https://www.notion.so/00cefe522a014408832781ff696ae1ba" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">以上表明，在C++中，NULL被定义为0，在C中，NULL被定义为(void *)0。如果有以下表达式：</span></span></p></div><pre id="https://www.notion.so/a15171c6c1b24c5d92e58aca1be4accb" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/39f35a8d24bf4197a0ec38dbd453628c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">此时p是一个空指针（null pointer），不指向任何实际对象。</span></span></p></div><div id="https://www.notion.so/de33ba44a218436db72267906049a569" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">此为第一点：C系语言中，0与NULL是可能等价的。</span></span></p></div><div id="https://www.notion.so/8935d9ee5de14054a005546a544d46b7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">那么空字符串我们又是怎么把它和NULL牵扯在一起的呢？</span></span></p></div><div id="https://www.notion.so/7afc61d88e084f25bf67b9b598c6023d" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">2️⃣</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">在java语言</span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">org.apache.commons.lang3.StringUtils</em></span><span class="SemanticString">中，使用</span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">isBlank()</em></span><span class="SemanticString">方法对null和空字符串进行判断，结果都为true。也就是通过</span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">isBlank()</em></span><span class="SemanticString">方法，这两者被关联起来，但我们却忽略了这种等价不满足传递性（即f(A)=C，f(B)=C无法推出A=B），我们看一下源码：</span></span></p></div><pre id="https://www.notion.so/aa11363fe697496aa1c2b236ace054b7" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isBlank</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">CharSequence</span> cs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> strLen <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>strLen <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> strLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isWhitespace</span><span class="token punctuation">(</span>cs<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 计算长度时null的长度为0</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">CharSequence</span> cs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> cs <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> cs<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/31035ea18b7d4d4c860e5a036227b16c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">由于null与空字符串&quot;&quot;的长度都是0，所以都被判断为blank。所以我们容易把null与空字符串混淆在一起。</span></span></p></div><div id="https://www.notion.so/5f8d24d01a50412797afdfcd9b7d42bd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">以上偏主观的分析，其实并非没有意义，因为在我们的认知过程中，总会被一些学习痕迹给带偏，这是我们需要避免的。</span></span></p></div><h1 id="https://www.notion.so/7317f75426f9426e89a1051da984ded7" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/7317f75426f9426e89a1051da984ded7"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen">2.MySQL中NULL的反直觉天坑</mark></span></span></h1><div id="https://www.notion.so/ea7e9debe21e4fa1894d42367ba98773" class="Divider"></div><div id="https://www.notion.so/4b4a3d1ec0ed4ea4988c9b41ad654acf" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">❓</div></div><p class="Callout__Content"><span class="SemanticStringArray"></span><div id="https://www.notion.so/00f37c367d544de59532f6e355dae93c" class="ColorfulBlock ColorfulBlock--BgGray Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">NULL的长度值是多少？</span></span></p></div></p></div><div id="https://www.notion.so/1c9bdd241f6f40f2ba8a3423f2ac3149" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">我们可以执行以下命令验证（InnoDB引擎，下同）：</span></span></p></div><pre id="https://www.notion.so/b6e08951d0864a8e985326564a745f79" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>mysql<span class="token operator">></span> select <span class="token function">length</span><span class="token punctuation">(</span>''<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
 <span class="token operator">|</span> <span class="token function">length</span><span class="token punctuation">(</span>''<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">|</span>
 <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
 <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span>         <span class="token constant">NULL</span> <span class="token operator">|</span>
 <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
 <span class="token number">1</span> row in set <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/4854778f568047e4ba35095b9e93dcaa" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">可见MySQL中NULL的长度是NULL，而不是0，挺反直觉的，因此我们得出结论：</span></span></p></div><div id="https://www.notion.so/34c5420280a24e01a9df783315e8d758" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">🗣</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">MySQL中NULL的长度是NULL，而不是0</span></span></p></div><div id="https://www.notion.so/daa7db713380462fb09d425639ba7a8f" class="Divider"></div><div id="https://www.notion.so/bbac377b97064bee8b103d1a53aed016" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/455239e991444bfea6bfde765ab9a14b" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">❓</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">COUNT函数是否会统计NULL字段？</span></span></p></div><div id="https://www.notion.so/f6a48059333440198e006215ce8032e3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">我们在一张用户会话表core_session表实验一下。</span></span></p></div><div id="https://www.notion.so/6e10a72902064b49962d2579d6fb1696" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">首先统计下mobile_no字段有多少是为NULL的：</span></span></p></div><div id="https://www.notion.so/c0066a65d5664e4b8fc9eb6e7ddd4123" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fbb901399-4478-4e02-92db-ae424f2c4468%2F3.png?width=573&amp;table=block&amp;id=c0066a65-d566-4e4b-8fc9-eb6e7ddd4123"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fbb901399-4478-4e02-92db-ae424f2c4468%2F3.png?width=573&amp;table=block&amp;id=c0066a65-d566-4e4b-8fc9-eb6e7ddd4123" style="width:573px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/f07a9e5ee609424c90436dac925cac58" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">有63次会话记录中手机号mobile_no为NULL。</span></span></p></div><div id="https://www.notion.so/250d2fef18534219a8182910f244674d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">我们用COUNT(*)统计，结果为：</span></span></p></div><div id="https://www.notion.so/85af24caa03d4eb68adaa39f25fc0628" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F77328f81-a545-4f36-a223-75337f708b51%2F2.png?width=362&amp;table=block&amp;id=85af24ca-a03d-4eb6-8ada-a39f25fc0628"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F77328f81-a545-4f36-a223-75337f708b51%2F2.png?width=362&amp;table=block&amp;id=85af24ca-a03d-4eb6-8ada-a39f25fc0628" style="width:362px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/8fce9705000c4969979c3a90ad1d49a6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">COUNT(*) 为3099条。</span></span></p></div><div id="https://www.notion.so/476c90921b2c474aa972ffcaab3b80a9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">接下来我们用COUNT(mobile_no)统计，结果为：</span></span></p></div><div id="https://www.notion.so/5236dc81585a4b709f8c8188b217106e" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F3997dbb1-8c54-4fa7-9e1d-0f0f2a092661%2F1.png?width=412&amp;table=block&amp;id=5236dc81-585a-4b70-9f8c-8188b217106e"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F3997dbb1-8c54-4fa7-9e1d-0f0f2a092661%2F1.png?width=412&amp;table=block&amp;id=5236dc81-585a-4b70-9f8c-8188b217106e" style="width:412px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/09ab11f849ce4dfaaa9409e934cb6fea" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">COUNT(mobile_no) 为3036条,而这和总记录数不等，且加上不为NULL的数量刚好为总记录数。因此引出第二条结论：</span></span></p></div><div id="https://www.notion.so/b6791bd0818a419696f4458daff1a7b2" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">🗣</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">COUNT(*)：统计所有行数
COUNT(某个字段)：该字段为NULL不计入统计</span></span></p></div><div id="https://www.notion.so/df4ac0032c53448f959f509f7f213f73" class="Divider"></div><div id="https://www.notion.so/2509ca4fe6b7496892fc8ca6d706b58c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/6fc0b29e3dac4a4ea86bd29a4ccdaf45" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">❓</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">NULL参与排序会怎样？</span></span></p></div><div id="https://www.notion.so/5f66c68f56fa487dbbc569edec65741c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">首先我们按照升序对mobile_no字段排序：</span></span></p></div><div id="https://www.notion.so/39b72e2fbd90474884ee6bfb86e209cc" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F2cc49e6c-1f41-4a25-9927-c14798f7bcce%2F4.png?width=587&amp;table=block&amp;id=39b72e2f-bd90-4748-84ee-6bfb86e209cc"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F2cc49e6c-1f41-4a25-9927-c14798f7bcce%2F4.png?width=587&amp;table=block&amp;id=39b72e2f-bd90-4748-84ee-6bfb86e209cc" style="width:587px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/f26ce0dd58e64694a50f84f35ee6d8ff" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">可见升序排序时，NULL会排到非NULL的前面。</span></span></p></div><div id="https://www.notion.so/3ea640a28d554f99bf077a2ee9ff2b6f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">再看一下降序排序：</span></span></p></div><div id="https://www.notion.so/7caf7a44928e4ef3b7bc263c083d96b6" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fcb06399c-a368-4a45-889a-03fc9e5757fb%2F5.png?width=754&amp;table=block&amp;id=7caf7a44-928e-4ef3-b7bc-263c083d96b6"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fcb06399c-a368-4a45-889a-03fc9e5757fb%2F5.png?width=754&amp;table=block&amp;id=7caf7a44-928e-4ef3-b7bc-263c083d96b6" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/734b8816fdbd430180900fe9559e96f5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">可见降序时，NULL会排到非NULL的后面。因此我们可以得出结论：</span></span></p></div><div id="https://www.notion.so/b28f9d9ef0734caaa6c0c20767974ed7" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">🗣</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">NULL参与排序时，降序会排在其他值前面，升序会排在其他值后边。但并不是NULL就比其他值小，只是MySQL的一种约定而已。</span></span></p></div><div id="https://www.notion.so/c82f1bbbcddd4c4d88fbdd33cc003d6d" class="Divider"></div><div id="https://www.notion.so/f0105c308f5b4620a455306fe09aa659" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">❓</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">唯一索引如果插入多个NULL会怎样？</span></span></p></div><div id="https://www.notion.so/de5170cbda224108967c4da3c1ae48d0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">我们建一张test表，将mobile_no字段设置为允许为NULL且是唯一索引（验证需要，实际开发中不能这样做）：</span></span></p></div><pre id="https://www.notion.so/f1808194fb9048919cf4c364f0ec046e" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>test<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>customer_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'APP客户ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>mobile_no<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'手机号'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>ind_mobile_no<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>mobile_no<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'测试表'</span></span></span></span></code></pre><div id="https://www.notion.so/6ddc04d10a7a440f8e5ccc9f81914443" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">多次插入mobile_no为NULL，结果为：</span></span></p></div><div id="https://www.notion.so/157d2d4b33c84ea5b62ad7fbdabd28ac" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F85040c82-c66f-4b8e-be9a-d1856ea7027d%2F7.png?width=487&amp;table=block&amp;id=157d2d4b-33c8-4ea5-b62a-d7fbdabd28ac"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F85040c82-c66f-4b8e-be9a-d1856ea7027d%2F7.png?width=487&amp;table=block&amp;id=157d2d4b-33c8-4ea5-b62a-d7fbdabd28ac" style="width:487px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/3e9f346b25404b279d06a79ac5ca0393" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">以上并未因为mobile_no是唯一索引而报错，即唯一索引如果为NULL时是允许多条记录的，这恰好与“唯一索引”的设计初衷相悖，所以唯一索引字段，应不能为NULL。</span></span></p></div><div id="https://www.notion.so/871044d1020f40c1b183122f5e8af9f5" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">🗣</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">唯一索引如果插入多个NULL，是不受唯一性约束的。所以唯一索引不能设置为NULL。</span></span></p></div><div id="https://www.notion.so/ff67b307989e40119b7798217bff6020" class="Divider"></div><h2 id="https://www.notion.so/c0fb82299bf74a2a886b73ce8d4196af" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/c0fb82299bf74a2a886b73ce8d4196af"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">下面这个坑非常重要！</code></span></span></h2><div id="https://www.notion.so/d0454deeb9b64278aaa685a804e5ce4a" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">❓</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">字段</span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorYellow">a</mark></span><span class="SemanticString">的取值为(&#x27;a&#x27;, &#x27;A&#x27;, NULL)，那么 a ！= NULL 结果是怎样的？</span></span></p></div><div id="https://www.notion.so/ed94f28d25f343349f93168e0a6b7844" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">为了验证这个问题，我们在上面的表中插入一个手机号：</span></span></p></div><div id="https://www.notion.so/da3ef291c56044489136427f105ff024" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Faccdfe4a-1de5-4ce4-8102-aba6e9426b1b%2F8.png?width=344&amp;table=block&amp;id=da3ef291-c560-4448-9136-427f105ff024"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Faccdfe4a-1de5-4ce4-8102-aba6e9426b1b%2F8.png?width=344&amp;table=block&amp;id=da3ef291-c560-4448-9136-427f105ff024" style="width:344px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/8b95d7dfd64b4b91a2f69f490fbd449e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">我们执行以下语句：</span></span></p></div><div id="https://www.notion.so/eaf4cb5785414e7abf52b455d6d87ce5" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F145ad2c6-d30f-4deb-80a9-f462eba60275%2F9.png?width=430&amp;table=block&amp;id=eaf4cb57-8541-4e7a-bf52-b455d6d87ce5"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F145ad2c6-d30f-4deb-80a9-f462eba60275%2F9.png?width=430&amp;table=block&amp;id=eaf4cb57-8541-4e7a-bf52-b455d6d87ce5" style="width:430px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/eb464bd67b804d68aea879726f3bd2e4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">上述语句竟然没有命中一条数据，同时验证了 &#x27;18012345678&#x27; ！= null 这个判断 是false</code></span><span class="SemanticString"> </span></span></p></div><div id="https://www.notion.so/22c7e843db7647d788f3b34ada8e5da5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">这是可以解释的，NULL在MySQL中表示“没有值”，一个不存在的值，和任何值去做不等式比较，都应该为false。如果为true，说明NULL这是一个可比较的值，并不是一个不存在的值，与定义相违背。</span></span></p></div><div id="https://www.notion.so/3629bad5aeff430b8fe23ea8fa17f4ec" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">🗣</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">任意值 ≠ NULL</code></span><span class="SemanticString"> 的判断，结果都是false</span></span></p></div><h1 id="https://www.notion.so/0d005ad1308a4b888af5c808a04994c2" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/0d005ad1308a4b888af5c808a04994c2"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen">3.一个NULL导致的生产问题</mark></span></span></h1><div id="https://www.notion.so/42cb264baab14eeaa5dea0188b67c8c7" class="Divider"></div><div id="https://www.notion.so/17c539c536d546459764309a1f79ba40" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">🛠</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">某个表demo的biz_type字段允许NULL值，因版本兼容需要，旧版本要将biz_type新增的类型值（假设新增的为005、006）过滤掉，只展示存量类型（001-004）</span></span></p></div><div id="https://www.notion.so/929334747ae044aba015bb5be939d81c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">伪代码：</span></span></p></div><pre id="https://www.notion.so/55631e03f20d410299b5392967f14f96" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">if</span> 旧版本<span class="token operator">:</span>
   查询不含<span class="token number">005</span><span class="token operator">/</span><span class="token number">006</span>的记录<span class="token operator">:</span> <span class="token function">selectOld</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">else</span>
   全部查询：<span class="token function">selectAll</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/c15135192a6241569c332e1d9f40d265" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">问题出现在selectOld(id):</span></span></p></div><pre id="https://www.notion.so/3dbc60b114a94d93b4a0dc84d2cdefbe" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>select <span class="token operator">*</span> from demo where biz_type not in <span class="token punctuation">(</span><span class="token char">'005'</span><span class="token punctuation">,</span> <span class="token char">'006'</span><span class="token punctuation">)</span> and id <span class="token operator">=</span> <span class="token char">'id-xxx'</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/5fb37d0789574e27a1b23537e1dd35a1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">以上SQL语句，希望将该用户的记录查询出来，但不包含新增场景005/006的记录。但是查询结果中，场景003对应的记录也被过滤掉了。</span></span></p></div><div id="https://www.notion.so/1b270c044195436397f295d26d88d814" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">经分析，003场景在数据库中对应的biz_type字段值其实是NULL。即：</span></span></p></div><div id="https://www.notion.so/73324603cb2d437097ec0f60b8deb1c4" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">⚠️</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">biz_type not in (&#x27;005&#x27;, &#x27;006&#x27;) 会将为NULL的一起过滤掉。</span></span></p></div><div id="https://www.notion.so/80213ec80ac54c03879a6e974ab2daeb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/a51e0d19597749c88927071b80b5247c" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">👨🏻‍💻</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">根因分析：
MySQL中，not in的实现原理是，将字段值与list（即括号中值）中的值一一比较，因此：
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">biz_type not in (&#x27;005&#x27;, &#x27;006&#x27;)</code></span><span class="SemanticString">
等价于
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">biz_type != &#x27;005&#x27; and biz_type != &#x27;006&#x27;</code></span><span class="SemanticString">
由第3节的铺垫我们知道：
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">任何值 ！= NULL</code></span><span class="SemanticString"> 的结果都是false，
所以该导致整个where的结果为false，因此为NULL的就查不出来。</span></span></p></div><div id="https://www.notion.so/fbb135a3f2bf424fbdec39080ead8cfa" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">✅</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">修复：
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">select * from demo where (biz_type is null or biz_type not in (&#x27;005&#x27;, &#x27;006&#x27;)) and id = &#x27;id-xxx&#x27;</code></span><span class="SemanticString">;</span></span></p></div><div id="https://www.notion.so/0aab7eb993e443b89b60a788778ddb0d" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">📢</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">总结：
NULL值不应该作为默认值存储。SQL语句后一定要先在测试环境验证，并结合行内SQL分析工具检查结果，同时要提示测试回归对应场景，以防遗漏。</span></span></p></div><div id="https://www.notion.so/69765c387f124d20862dda12cb80fc10" class="Divider"></div><div id="https://www.notion.so/3d5e863eb63c4cc7a6e4a3d0fa9eb527" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">最后，贴上《</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorBlue">高性能MySQL</mark></strong></span><span class="SemanticString">》中的这段关于NULL的描述作为结尾：</span></span></p></div><div id="https://www.notion.so/fa99bb4cdeb44e85901e9f4e0372965c" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F04d26262-9328-4271-80c4-1a9547f41187%2F10.jpg?width=3024&amp;table=block&amp;id=fa99bb4c-deb4-4e85-901e-9f4e0372965c"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F04d26262-9328-4271-80c4-1a9547f41187%2F10.jpg?width=3024&amp;table=block&amp;id=fa99bb4c-deb4-4e85-901e-9f4e0372965c" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><h1 id="https://www.notion.so/e97a9df469eb41498457bb8306e01f08" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/e97a9df469eb41498457bb8306e01f08"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen">4.结束语</mark></span></span></h1><div id="https://www.notion.so/49242854e0fc4ec2ae41f523e51cd58b" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">🌜</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">本文主要是分析和实验了MySQL中NULL的特性，存在很多反直觉的坑，是开发人员应该特别留意的。为了能减少NULL带来的坑，我们还是要如《高性能MySQL》中建议：尽量避免NULL。其次，SQL语句一定要先执行验证甚至可让运维同事帮忙生产验证，再结合SQL分析工具优化，如果涉及到旧功能，需主动提醒测试回归覆盖该场景。</span></span></p></div><div id="https://www.notion.so/6d8d07c060474949bc557df7cc8ca34a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></article><script src="https://utteranc.es/client.js"
        repo="gendlee/gendlee.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><script src="https://utteranc.es/client.js"
        repo="gendlee/gendlee.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
  <footer class="Footer">
  <div>&copy; 李正的自留地 2024</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>

</body>

</html>